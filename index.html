<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–ç•Œå„å›½ GDP åŠ¨æ€å¯è§†åŒ–åˆ†æ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson@3"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <h1>ğŸ† ä¸–ç•Œå„å›½ GDP åŠ¨æ€æ’åä¸æ·±åº¦åˆ†æ (1990-2023)</h1>
        <p>æ•°æ®é©±åŠ¨çš„å®è§‚ç»æµå˜åŒ–å¯è§†åŒ–</p>
    </header>

    <div class="container">

        <section class="controls-panel">
            <div class="control-group">
                <label for="speed-select">åŠ¨ç”»é€Ÿåº¦ (å¹´/ç§’):</label>
                <select id="speed-select">
                    <option value="1000">1.0</option>
                    <option value="500" selected>2.0 (é»˜è®¤)</option>
                    <option value="250">4.0</option>
                    <option value="100">10.0 (æå¿«)</option>
                </select>
            </div>
            <div class="control-group">
                <button id="start-btn">â–¶ï¸ å¼€å§‹æ’­æ”¾</button>
                <button id="pause-btn" style="display: none;">â¸ï¸ æš‚åœ</button>
                <button id="reset-btn">ğŸ”„ é‡ç½®</button>
            </div>
            <div class="control-group">
                <label for="year-slider">å¹´ä»½é€‰æ‹©:</label>
                <input type="range" id="year-slider" min="1990" max="2023" step="1" value="1990">
                <span id="current-year-display">1990</span>
            </div>
        </section>

        <section class="chart-section">
            <h2>ğŸŒ ä¸–ç•Œä¸»è¦å›½å®¶ GDP æ’åå‰ååŠ¨æ€å˜åŒ–</h2>
            <div id="chart">
                <div id="year-label">1990</div>
                <div id="event-annotation" class="annotation"></div>
            </div>
        </section>

        <section class="detail-section">
            
            <div class="card" id="line-chart-section">
                <h2>ğŸ“Š é€‰å®šå›½å®¶ GDP å˜åŒ–æŸ±çŠ¶å›¾ (ä¸‡äº¿ç¾å…ƒ)</h2>
                <div class="line-chart-controls">
                    <label>é€‰æ‹©å›½å®¶ (å¯å¤šé€‰):</label>
                    <select id="country-select" multiple size="5"></select>
                    <button id="draw-line-chart">ç»˜åˆ¶æŸ±çŠ¶å›¾</button>
                </div>
                <div id="line-chart"></div>
            </div>

            <div class="card" id="china-gdp-analysis">
                <h2>ğŸ‡¨ğŸ‡³ ä¸­å›½ GDP ç»†è‡´åˆ†æ (ä¸‡äº¿ç¾å…ƒ)</h2>
                <h3>æŒ‰å¹´ä»½æŸ¥çœ‹ä¸­å›½ GDP å¢é•¿</h3>
                <div class="line-chart-controls">
                    <label for="china-start-year">èµ·å§‹å¹´ä»½:</label>
                    <select id="china-start-year"></select>
                    <label for="china-end-year">ç»“æŸå¹´ä»½:</label>
                    <select id="china-end-year"></select>
                    <button id="draw-china-chart">æŸ¥çœ‹å˜åŒ–</button>
                </div>
                <div id="china-line-chart"></div>
            </div>

            <div class="card" id="china-provinces-gdp">
                <h2>ğŸ—ºï¸ ä¸­å›½å„çœ GDP ç»„æˆåˆ†æ (ä¸‡äº¿ç¾å…ƒ)</h2>
                <h3>æŒ‰å¹´ä»½æŸ¥çœ‹å„çœ GDP åˆ†å¸ƒ</h3>
                <div class="line-chart-controls">
                    <label for="province-year-select">é€‰æ‹©å¹´ä»½:</label>
                    <select id="province-year-select"></select>
                    <button id="draw-province-chart">æ˜¾ç¤ºåˆ†å¸ƒ</button>
                    <button id="toggle-province-view">åˆ‡æ¢è§†å›¾</button>
                </div>
                <div id="province-chart"></div>
            </div>

            <div class="card" id="world-map-gdp">
                <h2>ğŸŒ ä¸–ç•Œåœ°å›¾ GDP å¯è§†åŒ– (ä¸‡äº¿ç¾å…ƒ)</h2>
                <h3>æŒ‰å¹´ä»½æŸ¥çœ‹å„å›½ GDP åˆ†å¸ƒ</h3>
                <div class="line-chart-controls">
                    <label for="map-year-select">é€‰æ‹©å¹´ä»½:</label>
                    <select id="map-year-select"></select>
                    <button id="draw-map">æ˜¾ç¤ºåœ°å›¾</button>
                    <button id="reset-map-zoom">é‡ç½®ç¼©æ”¾</button>
                </div>
                <div id="map-legend"></div>
                <div id="world-map-chart"></div>
                <div id="map-tooltip" class="tooltip"></div>
            </div>

        </section>

    </div> <script>
        const WIDTH = 900;
        const HEIGHT = 400;
        const MARGIN = { top: 20, right: 30, bottom: 40, left: 60 }; // è°ƒæ•´åº•éƒ¨è£•é‡ä»¥å®¹çº³æ—‹è½¬çš„å¹´ä»½æ ‡ç­¾
        const NUM_BARS = 10; // åªæ˜¾ç¤ºå‰10å

        let data = [];
        let events = [];
        let provincesData = [];
        let countryNameMapping = {};
        let worldMapData = null;
        let yearIndex = 0;
        let timer = null;
        let intervalTime = 500; // é»˜è®¤ 2.0 å¹´/ç§’
        let provinceViewMode = 'bar'; // 'bar' æˆ– 'pie'
        let mapZoom = null;

        const svg = d3.select("#chart").append("svg")
            .attr("viewBox", `0 0 ${WIDTH} ${HEIGHT}`)
            .attr("width", "100%")
            .attr("height", "100%");

        const x = d3.scaleLinear().range([MARGIN.left, WIDTH - MARGIN.right]);
        const y = d3.scaleBand()
            .range([MARGIN.top, HEIGHT - MARGIN.bottom])
            .padding(0.1);
        
        // --- å·¥å…·å‡½æ•°: æ ¼å¼åŒ– GDP å€¼ ---
        const formatGDP = (d) => `${d.toFixed(2)} T`; // ä¿ç•™ä¸¤ä½å°æ•°ï¼Œå•ä½ä¸º T (ä¸‡äº¿ç¾å…ƒ)

        // --- æ•°æ®åŠ è½½ä¸åˆå§‹åŒ– ---
        async function loadData() {
            try {
                data = await d3.json("data.json");
                events = await d3.json("events.json");
                
                // åŠ è½½å›½å®¶åç§°æ˜ å°„
                try {
                    countryNameMapping = await d3.json("country-name-mapping.json");
                } catch (error) {
                    console.warn("åŠ è½½å›½å®¶åç§°æ˜ å°„å¤±è´¥:", error);
                }
                
                // åŠ è½½ä¸­å›½å„çœGDPæ•°æ®
                try {
                    provincesData = await d3.json("china-provinces-gdp.json");
                    provincesData.sort((a, b) => a.year - b.year);
                    
                    // å¡«å……çœä»½å¹´ä»½é€‰æ‹©å™¨
                    const provinceYears = provincesData.map(d => d.year);
                    const provinceYearOptions = provinceYears.map(y => `<option value="${y}">${y}</option>`).join('');
                    d3.select("#province-year-select").html(provinceYearOptions).property("value", provinceYears[provinceYears.length - 1]);
                } catch (error) {
                    console.warn("åŠ è½½çœä»½æ•°æ®å¤±è´¥:", error);
                    d3.select("#province-chart").html("<p style='color:red;'>çœä»½æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ china-provinces-gdp.json æ–‡ä»¶ã€‚</p>");
                }
                
                if (data.length === 0) {
                    d3.select("#chart").html("<p style='color:red;'>æ•°æ®åŠ è½½å¤±è´¥ï¼šdata.json æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯ã€‚è¯·å…ˆè¿è¡Œ Python è„šæœ¬ç”Ÿæˆæ­£ç¡®çš„æ•°æ®æ–‡ä»¶ã€‚</p>");
                    return;
                }

                data.sort((a, b) => a.year - b.year);
                
                const minYear = data[0].year;
                const maxYear = data[data.length - 1].year;
                d3.select("#year-slider").attr("min", minYear).attr("max", maxYear).property("value", minYear);
                d3.select("#current-year-display").text(minYear);
                
                // åŠ è½½åœ°å›¾å¹´ä»½é€‰æ‹©å™¨å’Œå…¶ä»–å¹´ä»½é€‰æ‹©å™¨
                const years = data.map(d => d.year);
                const yearOptions = years.map(y => `<option value="${y}">${y}</option>`).join('');
                d3.select("#map-year-select").html(yearOptions).property("value", years[years.length - 1]);
                d3.select("#china-start-year").html(yearOptions).property("value", minYear);
                d3.select("#china-end-year").html(yearOptions).property("value", maxYear);
                
                updateBarChart(data[yearIndex]);
                
                const allCountries = Array.from(new Set(data.flatMap(d => d.data.map(c => c.country))))
                    .filter(c => c && data.some(d => d.data.some(cd => cd.country === c && cd.gdp > 0)))
                    .sort((a, b) => {
                         if (a === 'ä¸­å›½') return -1;
                         if (b === 'ä¸­å›½') return 1;
                         return d3.ascending(a, b);
                    });
                
                const countryOptions = allCountries.map(c => `<option value="${c}">${c}</option>`).join('');
                d3.select("#country-select").html(countryOptions);

            } catch (error) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
                d3.select("#chart").html("<p style='color:red;'>æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ data.json æˆ– events.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®ã€‚</p>");
            }
        }

        // --- åŠ¨æ€æ¡å½¢å›¾ç»˜åˆ¶å‡½æ•° (ä¿æŒä¸å˜) ---
        function updateBarChart(yearData) {
            const currentYear = yearData.year;
            
            const topData = yearData.data
                .filter(d => d.gdp > 0)
                .sort((a, b) => b.gdp - a.gdp)
                .slice(0, NUM_BARS);

            const maxGdp = d3.max(data.flatMap(d => d.data.map(c => c.gdp)));
            x.domain([0, maxGdp * 1.05]); 
            y.domain(topData.map(d => d.country)); 

            d3.select("#year-label").text(currentYear);
            d3.select("#year-slider").property("value", currentYear);
            d3.select("#current-year-display").text(currentYear);

            const eventAnnotation = d3.select("#event-annotation");
            const currentEvents = events.filter(e => e.year === currentYear);

            if (currentEvents.length > 0) {
                eventAnnotation
                    .html(`<strong>${currentEvents[0].highlight_country}:</strong> ${currentEvents[0].event}`)
                    .classed('annotation-visible', true);
            } else {
                eventAnnotation.classed('annotation-visible', false);
            }

            const bars = svg.selectAll(".bar")
                .data(topData, d => d.country);

            bars.exit().remove();

            const enterBars = bars.enter().append("rect")
                .attr("class", "bar")
                .attr("fill", d => d.color || "#ccc")
                .attr("height", y.bandwidth())
                .attr("x", MARGIN.left)
                .attr("width", 0) 
                .attr("y", d => y(d.country));

            enterBars.merge(bars)
                .transition()
                .duration(intervalTime * 0.9)
                .ease(d3.easeLinear)
                .attr("y", d => y(d.country)) 
                .attr("width", d => x(d.gdp)); 

            const labels = svg.selectAll(".label")
                .data(topData, d => d.country);
            
            labels.exit().remove();

            const enterLabels = labels.enter().append("text")
                .attr("class", "label")
                .attr("text-anchor", "start")
                .attr("x", d => x(d.gdp) + 5)
                .attr("y", d => y(d.country) + y.bandwidth() / 2 + 5);

            enterLabels.merge(labels)
                .transition()
                .duration(intervalTime * 0.9)
                .ease(d3.easeLinear)
                .attr("y", d => y(d.country) + y.bandwidth() / 2 + 5)
                .attr("x", d => x(d.gdp) + 5) 
                .text(d => `${d.country} (${formatGDP(d.gdp)})`);

            svg.selectAll(".axis--x").remove();
            svg.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", `translate(0,${HEIGHT - MARGIN.bottom})`)
                .call(d3.axisBottom(x).tickFormat(d => `${d.toFixed(0)}T`)); 
        }

        // --- åŠ¨ç”»æ§åˆ¶é€»è¾‘ (ä¿æŒä¸å˜) ---
        function runAnimation() {
            if (timer) return; 
            const totalYears = data.length;
            const currentSliderYear = +d3.select("#year-slider").property("value");
            const dataStartYear = data[0].year;
            yearIndex = currentSliderYear - dataStartYear;
            if (yearIndex < 0) yearIndex = 0;

            d3.select("#start-btn").style("display", "none");
            d3.select("#pause-btn").style("display", "inline-block");
            
            timer = d3.interval(() => {
                if (yearIndex < totalYears) {
                    updateBarChart(data[yearIndex]);
                    yearIndex++;
                } else {
                    stopAnimation();
                    d3.select("#start-btn").style("display", "inline-block").text("â–¶ï¸ é‡æ–°æ’­æ”¾");
                }
            }, intervalTime);
        }

        function stopAnimation() {
            if (timer) {
                timer.stop();
                timer = null;
                d3.select("#start-btn").style("display", "inline-block").text("â–¶ï¸ ç»§ç»­æ’­æ”¾");
                d3.select("#pause-btn").style("display", "none");
            }
        }

        function resetAnimation() {
            stopAnimation();
            yearIndex = 0;
            d3.select("#year-slider").property("value", data[0].year);
            updateBarChart(data[0]);
            d3.select("#start-btn").text("â–¶ï¸ å¼€å§‹æ’­æ”¾");
        }

        d3.select("#start-btn").on("click", runAnimation);
        d3.select("#pause-btn").on("click", stopAnimation);
        d3.select("#reset-btn").on("click", resetAnimation);

        d3.select("#speed-select").on("change", function() {
            intervalTime = +this.value;
            const isRunning = timer !== null;
            if (isRunning) {
                stopAnimation();
                runAnimation();
            }
        });

        d3.select("#year-slider").on("input", function() {
            stopAnimation();
            const selectedYear = +this.value;
            const dataPoint = data.find(d => d.year === selectedYear);
            if (dataPoint) {
                yearIndex = data.indexOf(dataPoint);
                updateBarChart(dataPoint);
            }
        });

        // --- æ—¶é—´åºåˆ—æŸ±çŠ¶å›¾ç»˜åˆ¶å‡½æ•° (drawTimeBarChart) ---
        function drawTimeBarChart(containerId, countries, startYear, endYear) {
            d3.select(containerId).select("svg").remove();

            if (countries.length === 0) {
                d3.select(containerId).html("<p style='text-align:center;'>è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªå›½å®¶è¿›è¡Œå¯¹æ¯”ã€‚</p>");
                return;
            }

            const chartContainer = d3.select(containerId).node();
            if (!chartContainer) return;

            const chartWidth = chartContainer.getBoundingClientRect().width;
            const chartHeight = 400;
            const margin = { top: 20, right: 20, bottom: 80, left: 60 }; // å¢å¤§åº•éƒ¨è£•é‡ä»¥å®¹çº³æ—‹è½¬çš„å¹´ä»½æ ‡ç­¾
            const innerWidth = chartWidth - margin.left - margin.right;
            const innerHeight = chartHeight - margin.top - margin.bottom;

            let lineData = [];
            const countryColors = {}; 
            let maxGdp = 0;

            // 1. è¿‡æ»¤å’Œæ•´ç†æ•°æ®
            data.filter(d => d.year >= startYear && d.year <= endYear).forEach(yearData => {
                yearData.data.forEach(countryData => {
                    if (countries.includes(countryData.country)) {
                        lineData.push({
                            year: yearData.year,
                            country: countryData.country,
                            gdp: countryData.gdp
                        });
                        if (countryData.gdp > maxGdp) maxGdp = countryData.gdp;
                        if (!countryColors[countryData.country]) {
                            countryColors[countryData.country] = countryData.color || '#999';
                        }
                    }
                });
            });

            if (lineData.length === 0) {
                d3.select(containerId).html("<p style='text-align:center;'>æ‰€é€‰å›½å®¶åœ¨æŒ‡å®šå¹´ä»½èŒƒå›´å†…æ²¡æœ‰æ•°æ®ã€‚</p>");
                return;
            }

            const allYears = Array.from(new Set(lineData.map(d => d.year))).sort(d3.ascending);
            
            // 2. å®šä¹‰å°ºåº¦
            // X0: å¹´ä»½å°ºåº¦ (ä¸»å°ºåº¦)
            const x0 = d3.scaleBand()
                .domain(allYears)
                .range([margin.left, chartWidth - margin.right])
                .paddingInner(0.1);

            // X1: å›½å®¶å°ºåº¦ (åµŒå¥—å°ºåº¦ï¼Œç”¨äºåˆ†ç»„)
            const x1 = d3.scaleBand()
                .domain(countries)
                .range([0, x0.bandwidth()])
                .padding(0.05);

            // Y: GDP å°ºåº¦
            const y = d3.scaleLinear()
                .domain([0, maxGdp * 1.05])
                .range([chartHeight - margin.bottom, margin.top]);

            // 3. åˆ›å»º SVG å®¹å™¨å’Œä¸»ç»˜å›¾åŒºåŸŸ
            const svgGroup = d3.select(containerId).append("svg")
                .attr("width", chartWidth)
                .attr("height", chartHeight)
                .append("g")
                .attr("transform", `translate(0, 0)`);

            // 4. ç»˜åˆ¶æŸ±å­
            const groupedData = d3.group(lineData, d => d.year);

            svgGroup.selectAll(".yearGroup")
                .data(groupedData)
                .join("g")
                .attr("class", "yearGroup")
                .attr("transform", d => `translate(${x0(d[0])}, 0)`)
                .selectAll(".bar")
                .data(d => d[1])
                .join("rect")
                .attr("class", "bar")
                .attr("x", d => x1(d.country))
                .attr("y", d => y(d.gdp))
                .attr("width", x1.bandwidth())
                .attr("height", d => innerHeight - y(d.gdp) + margin.top) // æŸ±å­é«˜åº¦
                .attr("fill", d => countryColors[d.country] || '#ccc')
                .style("opacity", 0) // åŠ¨ç”»å‡†å¤‡
                .transition()
                .duration(500)
                .ease(d3.easeQuadOut)
                .style("opacity", 1);


            // 5. ç»˜åˆ¶åæ ‡è½´
            // X è½´
            svgGroup.append("g")
                .attr("transform", `translate(0, ${chartHeight - margin.bottom})`)
                .call(d3.axisBottom(x0)
                    .tickValues(x0.domain().filter((d, i) => i % (Math.ceil(allYears.length / 10)) === 0)) // ç¨€ç–åˆ»åº¦
                )
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em");

            // Y è½´
            svgGroup.append("g")
                .attr("transform", `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(y).tickFormat(d => `${d.toFixed(0)}T`));

            // 6. ç»˜åˆ¶å›¾ä¾‹ (Legend)
            const legend = svgGroup.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .attr("text-anchor", "start")
                .selectAll("g")
                .data(countries)
                .join("g")
                .attr("transform", (d, i) => `translate(${chartWidth - margin.right + 10}, ${i * 20})`);

            legend.append("rect")
                .attr("x", 0)
                .attr("width", 19)
                .attr("height", 19)
                .attr("fill", d => countryColors[d] || '#ccc');

            legend.append("text")
                .attr("x", 24)
                .attr("y", 9.5)
                .attr("dy", "0.32em")
                .text(d => d);
        }
        
        // --- äº‹ä»¶ç›‘å¬å™¨ï¼šå…¨çƒå¯¹æ¯”æŸ±çŠ¶å›¾ (å¤šé€‰å·²ä¿®å¤) ---
        d3.select("#draw-line-chart").on("click", () => {
            const selectedOptions = d3.select("#country-select").property("options");
            const countries = Array.from(selectedOptions)
                .filter(option => option.selected)
                .map(option => option.value);
            
            const startYear = data.length > 0 ? data[0].year : 1990;
            const endYear = data.length > 0 ? data[data.length - 1].year : 2023;
            drawTimeBarChart("#line-chart", countries, startYear, endYear);
        });

        // --- äº‹ä»¶ç›‘å¬å™¨ï¼šä¸­å›½åˆ†ææŸ±çŠ¶å›¾ ---
        d3.select("#draw-china-chart").on("click", () => {
            const startYear = +d3.select("#china-start-year").property("value");
            const endYear = +d3.select("#china-end-year").property("value");
            
            if (startYear > endYear) {
                alert("èµ·å§‹å¹´ä»½ä¸èƒ½å¤§äºç»“æŸå¹´ä»½ï¼");
                return;
            }
            
            drawTimeBarChart("#china-line-chart", ["ä¸­å›½"], startYear, endYear);
        });

        // --- ä¸­å›½å„çœGDPå¯è§†åŒ–å‡½æ•° ---
        function drawProvinceChart() {
            if (provincesData.length === 0) {
                d3.select("#province-chart").html("<p style='color:red;'>çœä»½æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥æ•°æ®æ–‡ä»¶ã€‚</p>");
                return;
            }

            const selectedYear = +d3.select("#province-year-select").property("value");
            const yearData = provincesData.find(d => d.year === selectedYear);
            
            if (!yearData) {
                d3.select("#province-chart").html("<p style='color:red;'>æœªæ‰¾åˆ°è¯¥å¹´ä»½çš„æ•°æ®ã€‚</p>");
                return;
            }

            // ç§»é™¤æ—§å›¾è¡¨
            d3.select("#province-chart").select("svg").remove();

            if (provinceViewMode === 'bar') {
                drawProvinceBarChart(yearData);
            } else {
                drawProvincePieChart(yearData);
            }
        }

        // ç»˜åˆ¶çœä»½æ¡å½¢å›¾
        function drawProvinceBarChart(yearData) {
            const container = d3.select("#province-chart");
            const containerWidth = container.node().getBoundingClientRect().width || 800;
            const chartHeight = 600;
            const margin = { top: 40, right: 150, bottom: 60, left: 120 };

            // æ’åºæ•°æ®ï¼ˆæŒ‰GDPé™åºï¼‰
            const sortedProvinces = [...yearData.provinces]
                .filter(p => p.gdp > 0)
                .sort((a, b) => b.gdp - a.gdp);

            const x = d3.scaleLinear()
                .domain([0, d3.max(sortedProvinces, d => d.gdp) * 1.1])
                .range([margin.left, containerWidth - margin.right]);

            const y = d3.scaleBand()
                .domain(sortedProvinces.map(d => d.name))
                .range([margin.top, chartHeight - margin.bottom])
                .padding(0.15);

            const svg = container.append("svg")
                .attr("width", containerWidth)
                .attr("height", chartHeight);

            // ç»˜åˆ¶æ¡å½¢
            const bars = svg.selectAll(".province-bar")
                .data(sortedProvinces)
                .join("rect")
                .attr("class", "province-bar")
                .attr("x", margin.left)
                .attr("y", d => y(d.name))
                .attr("width", 0)
                .attr("height", y.bandwidth())
                .attr("fill", d => d.color)
                .attr("stroke", "#fff")
                .attr("stroke-width", 1)
                .transition()
                .duration(1000)
                .ease(d3.easeCubicOut)
                .attr("width", d => x(d.gdp) - margin.left);

            // æ·»åŠ GDPæ ‡ç­¾
            svg.selectAll(".province-label")
                .data(sortedProvinces)
                .join("text")
                .attr("class", "province-label")
                .attr("x", d => x(d.gdp) + 5)
                .attr("y", d => y(d.name) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .style("font-size", "12px")
                .style("fill", "#333")
                .text(d => `${d.gdp.toFixed(3)} ä¸‡äº¿ç¾å…ƒ`)
                .style("opacity", 0)
                .transition()
                .duration(1000)
                .delay(500)
                .style("opacity", 1);

            // æ·»åŠ çœä»½åç§°æ ‡ç­¾
            svg.selectAll(".province-name")
                .data(sortedProvinces)
                .join("text")
                .attr("class", "province-name")
                .attr("x", margin.left - 10)
                .attr("y", d => y(d.name) + y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "end")
                .style("font-size", "12px")
                .style("fill", "#333")
                .text(d => d.name);

            // æ·»åŠ Xè½´
            svg.append("g")
                .attr("transform", `translate(0, ${chartHeight - margin.bottom})`)
                .call(d3.axisBottom(x).tickFormat(d => `${d.toFixed(2)}T`))
                .style("font-size", "11px");

            // æ·»åŠ æ ‡é¢˜
            svg.append("text")
                .attr("x", containerWidth / 2)
                .attr("y", 25)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .text(`${yearData.year} å¹´ä¸­å›½å„çœ GDP æ’åï¼ˆä¸‡äº¿ç¾å…ƒï¼‰`);

            // æ·»åŠ æ€»è®¡
            const totalGDP = d3.sum(sortedProvinces, d => d.gdp);
            svg.append("text")
                .attr("x", containerWidth / 2)
                .attr("y", chartHeight - 10)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .text(`å…¨å›½ GDP æ€»è®¡: ${totalGDP.toFixed(3)} ä¸‡äº¿ç¾å…ƒ`);
        }

        // ç»˜åˆ¶çœä»½é¥¼å›¾
        function drawProvincePieChart(yearData) {
            const container = d3.select("#province-chart");
            const containerWidth = container.node().getBoundingClientRect().width || 800;
            const chartHeight = 600;
            const radius = Math.min(containerWidth, chartHeight) / 2 - 80;
            const margin = { top: 40, right: 40, bottom: 40, left: 40 };

            // è¿‡æ»¤å¹¶æ’åºæ•°æ®ï¼ˆåªæ˜¾ç¤ºå‰10åï¼Œå…¶ä»–åˆå¹¶ï¼‰
            const sortedProvinces = [...yearData.provinces]
                .filter(p => p.gdp > 0)
                .sort((a, b) => b.gdp - a.gdp);

            const top10 = sortedProvinces.slice(0, 10);
            const others = sortedProvinces.slice(10);
            const othersGDP = d3.sum(others, d => d.gdp);
            
            if (othersGDP > 0) {
                top10.push({
                    name: "å…¶ä»–çœä»½",
                    gdp: othersGDP,
                    color: "#D3D3D3"
                });
            }

            const pie = d3.pie()
                .value(d => d.gdp)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            const arcLabel = d3.arc()
                .innerRadius(radius + 20)
                .outerRadius(radius + 40);

            const svg = container.append("svg")
                .attr("width", containerWidth)
                .attr("height", chartHeight);

            const g = svg.append("g")
                .attr("transform", `translate(${containerWidth / 2}, ${chartHeight / 2})`);

            const arcs = g.selectAll(".arc")
                .data(pie(top10))
                .join("g")
                .attr("class", "arc");

            // ç»˜åˆ¶æ‰‡å½¢
            arcs.append("path")
                .attr("fill", d => d.data.color)
                .attr("stroke", "#fff")
                .attr("stroke-width", 2)
                .attr("d", arc)
                .style("opacity", 0)
                .transition()
                .duration(800)
                .style("opacity", 1)
                .attrTween("d", function(d) {
                    const interpolate = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
                    return function(t) {
                        return arc(interpolate(t));
                    };
                });

            // æ·»åŠ æ ‡ç­¾
            arcs.append("text")
                .attr("transform", d => `translate(${arcLabel.centroid(d)})`)
                .attr("dy", "0.35em")
                .style("font-size", "11px")
                .style("text-anchor", "middle")
                .style("font-weight", "bold")
                .text(d => {
                    const percentage = ((d.endAngle - d.startAngle) / (2 * Math.PI) * 100).toFixed(1);
                    return percentage > 3 ? `${d.data.name}\n${percentage}%` : '';
                });

            // æ·»åŠ å›¾ä¾‹
            const legend = svg.append("g")
                .attr("transform", `translate(${containerWidth - 200}, 60)`);

            const legendItems = legend.selectAll(".legend-item")
                .data(top10)
                .join("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(0, ${i * 20})`);

            legendItems.append("rect")
                .attr("width", 15)
                .attr("height", 15)
                .attr("fill", d => d.color);

            legendItems.append("text")
                .attr("x", 20)
                .attr("y", 12)
                .style("font-size", "11px")
                .text(d => `${d.name} (${d.gdp.toFixed(3)}T)`);

            // æ·»åŠ æ ‡é¢˜
            svg.append("text")
                .attr("x", containerWidth / 2)
                .attr("y", 25)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .text(`${yearData.year} å¹´ä¸­å›½å„çœ GDP å æ¯”åˆ†å¸ƒ`);

            // æ·»åŠ æ€»è®¡
            const totalGDP = d3.sum(top10, d => d.gdp);
            svg.append("text")
                .attr("x", containerWidth / 2)
                .attr("y", chartHeight - 10)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "bold")
                .text(`å…¨å›½ GDP æ€»è®¡: ${totalGDP.toFixed(3)} ä¸‡äº¿ç¾å…ƒ`);
        }

        // --- äº‹ä»¶ç›‘å¬å™¨ï¼šçœä»½GDPå›¾è¡¨ ---
        d3.select("#draw-province-chart").on("click", drawProvinceChart);
        
        d3.select("#toggle-province-view").on("click", function() {
            provinceViewMode = provinceViewMode === 'bar' ? 'pie' : 'bar';
            this.textContent = provinceViewMode === 'bar' ? 'åˆ‡æ¢ä¸ºé¥¼å›¾' : 'åˆ‡æ¢ä¸ºæ¡å½¢å›¾';
            drawProvinceChart();
        });

        // åˆå§‹è®¾ç½®åˆ‡æ¢æŒ‰é’®æ–‡æœ¬
        d3.select("#toggle-province-view").text("åˆ‡æ¢ä¸ºé¥¼å›¾");

        // --- ä¸–ç•Œåœ°å›¾GDPå¯è§†åŒ–åŠŸèƒ½ ---
        async function loadWorldMap() {
            try {
                // ä½¿ç”¨åœ¨çº¿ä¸–ç•Œåœ°å›¾æ•°æ® (TopoJSONæ ¼å¼ï¼Œæ¥è‡ªunpkg CDN)
                // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„ä¸–ç•Œåœ°å›¾ï¼Œé€‚åˆGDPå¯è§†åŒ–
                const url = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";
                worldMapData = await d3.json(url);
                return true;
            } catch (error) {
                console.error("åŠ è½½ä¸–ç•Œåœ°å›¾æ•°æ®å¤±è´¥:", error);
                d3.select("#world-map-chart").html(`
                    <div style="text-align:center; padding:40px; color:#666;">
                        <p>âš ï¸ æ— æ³•åŠ è½½åœ¨çº¿åœ°å›¾æ•°æ®</p>
                        <p style="font-size:12px;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–ä½¿ç”¨æœ¬åœ°åœ°å›¾æ•°æ®æ–‡ä»¶</p>
                        <p style="font-size:12px;">æç¤ºï¼šå¯ä»¥ä» <a href="https://github.com/topojson/world-atlas" target="_blank">world-atlas</a> ä¸‹è½½åœ°å›¾æ•°æ®</p>
                    </div>
                `);
                return false;
            }
        }

        function drawWorldMap() {
            if (!worldMapData) {
                loadWorldMap().then(loaded => {
                    if (loaded) drawWorldMap();
                });
                return;
            }

            if (data.length === 0) {
                d3.select("#world-map-chart").html("<p style='color:red;'>GDPæ•°æ®æœªåŠ è½½ï¼Œè¯·å…ˆåŠ è½½æ•°æ®æ–‡ä»¶ã€‚</p>");
                return;
            }

            const selectedYear = +d3.select("#map-year-select").property("value");
            const yearData = data.find(d => d.year === selectedYear);
            
            if (!yearData) {
                d3.select("#world-map-chart").html("<p style='color:red;'>æœªæ‰¾åˆ°è¯¥å¹´ä»½çš„æ•°æ®ã€‚</p>");
                return;
            }

            // æ¸…é™¤æ—§åœ°å›¾
            d3.select("#world-map-chart").selectAll("*").remove();
            d3.select("#map-legend").selectAll("*").remove();

            const container = d3.select("#world-map-chart");
            const containerWidth = container.node().getBoundingClientRect().width || 1000;
            const mapHeight = 600;
            const margin = { top: 20, right: 20, bottom: 20, left: 20 };

            // åˆ›å»ºGDPæ•°æ®æ˜ å°„ï¼ˆä¸­æ–‡å -> GDPå€¼ï¼‰
            const gdpMap = {};
            yearData.data.forEach(d => {
                if (d.gdp > 0) {
                    gdpMap[d.country] = d.gdp;
                }
            });

            // åˆ›å»ºé¢œè‰²åˆ†çº§
            const maxGDP = d3.max(Object.values(gdpMap));
            const colorScale = d3.scaleThreshold()
                .domain([0.1, 0.5, 1, 2, 5, 10, 20])
                .range([
                    "#e8f4f8",  // æä½ (0-0.1T)
                    "#b3d9e6",  // å¾ˆä½ (0.1-0.5T)
                    "#66b3d9",  // ä½ (0.5-1T)
                    "#3399cc",  // ä¸­ä½ (1-2T)
                    "#0066cc",  // ä¸­ (2-5T)
                    "#004080",  // é«˜ (5-10T)
                    "#00264d"   // æé«˜ (>10T)
                ]);

            // åˆ›å»ºåå‘æ˜ å°„ï¼ˆè‹±æ–‡å -> ä¸­æ–‡åï¼‰å’Œåç§°å˜ä½“æ˜ å°„
            const reverseMapping = {};
            const nameVariants = {};
            
            Object.entries(countryNameMapping).forEach(([chineseName, englishName]) => {
                reverseMapping[englishName] = chineseName;
                reverseMapping[englishName.toLowerCase()] = chineseName;
                // åˆ›å»ºä¸€äº›å¸¸è§å˜ä½“
                nameVariants[englishName.replace(/\s+/g, "")] = chineseName;
                nameVariants[englishName.replace(/\s+/g, "").toLowerCase()] = chineseName;
            });

            // å¸¸è§å›½å®¶åç§°æ˜ å°„ï¼ˆå¤„ç†åœ°å›¾æ•°æ®ä¸­çš„ä¸åŒåç§°æ ¼å¼ï¼‰
            const commonNameMappings = {
                "United States": "United States of America",
                "USA": "United States of America",
                "US": "United States of America",
                "Russia": "Russia",
                "Russian Federation": "Russia",
                "South Korea": "South Korea",
                "Korea, South": "South Korea",
                "Republic of Korea": "South Korea",
                "North Korea": "North Korea",
                "Korea, North": "North Korea",
                "UK": "United Kingdom",
                "U.K.": "United Kingdom",
                "Czech Republic": "Czech Republic",
                "Czechia": "Czech Republic"
            };

            function getGDPColor(countryName) {
                if (!countryName) return "#e0e0e0";
                
                // å°è¯•ç›´æ¥åŒ¹é…ä¸­æ–‡å
                if (gdpMap[countryName]) {
                    return colorScale(gdpMap[countryName]);
                }
                
                // æ ‡å‡†åŒ–å›½å®¶åç§°
                let normalizedName = countryName;
                if (commonNameMappings[countryName]) {
                    normalizedName = commonNameMappings[countryName];
                }
                
                // å°è¯•é€šè¿‡è‹±æ–‡åæ˜ å°„
                if (reverseMapping[normalizedName] || reverseMapping[normalizedName.toLowerCase()]) {
                    const chineseName = reverseMapping[normalizedName] || reverseMapping[normalizedName.toLowerCase()];
                    if (gdpMap[chineseName]) {
                        return colorScale(gdpMap[chineseName]);
                    }
                }
                
                // å°è¯•åç§°å˜ä½“åŒ¹é…
                const noSpaceName = normalizedName.replace(/\s+/g, "");
                if (nameVariants[noSpaceName] || nameVariants[noSpaceName.toLowerCase()]) {
                    const chineseName = nameVariants[noSpaceName] || nameVariants[noSpaceName.toLowerCase()];
                    if (gdpMap[chineseName]) {
                        return colorScale(gdpMap[chineseName]);
                    }
                }
                
                // æ— æ•°æ®æ—¶è¿”å›ç°è‰²
                return "#e0e0e0";
            }

            function getGDPValue(countryName) {
                if (!countryName) return null;
                
                if (gdpMap[countryName]) {
                    return gdpMap[countryName];
                }
                
                // æ ‡å‡†åŒ–å›½å®¶åç§°
                let normalizedName = countryName;
                if (commonNameMappings[countryName]) {
                    normalizedName = commonNameMappings[countryName];
                }
                
                // å°è¯•é€šè¿‡è‹±æ–‡åæ˜ å°„
                if (reverseMapping[normalizedName] || reverseMapping[normalizedName.toLowerCase()]) {
                    const chineseName = reverseMapping[normalizedName] || reverseMapping[normalizedName.toLowerCase()];
                    if (gdpMap[chineseName]) {
                        return gdpMap[chineseName];
                    }
                }
                
                // å°è¯•åç§°å˜ä½“åŒ¹é…
                const noSpaceName = normalizedName.replace(/\s+/g, "");
                if (nameVariants[noSpaceName] || nameVariants[noSpaceName.toLowerCase()]) {
                    const chineseName = nameVariants[noSpaceName] || nameVariants[noSpaceName.toLowerCase()];
                    if (gdpMap[chineseName]) {
                        return gdpMap[chineseName];
                    }
                }
                
                return null;
            }
            
            function getChineseName(countryName) {
                if (gdpMap[countryName]) return countryName;
                let normalizedName = countryName;
                if (commonNameMappings[countryName]) {
                    normalizedName = commonNameMappings[countryName];
                }
                return reverseMapping[normalizedName] || reverseMapping[normalizedName.toLowerCase()] || countryName;
            }

            // åˆ›å»ºæŠ•å½±
            const projection = d3.geoNaturalEarth1()
                .scale((containerWidth - margin.left - margin.right) / 6.5)
                .translate([(containerWidth - margin.left - margin.right) / 2, (mapHeight - margin.top - margin.bottom) / 2]);

            const path = d3.geoPath().projection(projection);

            // åˆ›å»ºSVG
            const svg = container.append("svg")
                .attr("width", containerWidth)
                .attr("height", mapHeight);

            const mapGroup = svg.append("g")
                .attr("class", "map-group");

            // è½¬æ¢TopoJSONä¸ºGeoJSON
            // å°è¯•ä¸åŒçš„å¯¹è±¡åç§°
            let countriesObject = null;
            if (worldMapData.objects.countries) {
                countriesObject = worldMapData.objects.countries;
            } else if (worldMapData.objects.countries_110m) {
                countriesObject = worldMapData.objects.countries_110m;
            } else {
                // è·å–ç¬¬ä¸€ä¸ªå¯¹è±¡
                const objectKeys = Object.keys(worldMapData.objects);
                if (objectKeys.length > 0) {
                    countriesObject = worldMapData.objects[objectKeys[0]];
                }
            }
            
            if (!countriesObject) {
                d3.select("#world-map-chart").html("<p style='color:red;'>åœ°å›¾æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚</p>");
                return;
            }
            
            const countries = topojson.feature(worldMapData, countriesObject);

            // ç»˜åˆ¶å›½å®¶
            mapGroup.selectAll(".country")
                .data(countries.features)
                .enter()
                .append("path")
                .attr("class", "country")
                .attr("d", path)
                .attr("fill", d => {
                    const countryName = d.properties.NAME || d.properties.name || "";
                    return getGDPColor(countryName);
                })
                .attr("stroke", "#fff")
                .attr("stroke-width", 0.5)
                .style("cursor", "pointer")
                .on("mouseover", function(event, d) {
                    const countryName = d.properties.NAME || d.properties.name || d.properties.NAME_LONG || "";
                    const chineseName = getChineseName(countryName);
                    const gdpValue = getGDPValue(countryName);
                    
                    d3.select(this)
                        .attr("stroke", "#333")
                        .attr("stroke-width", 2);

                    const tooltip = d3.select("#map-tooltip");
                    const displayName = chineseName !== countryName ? `${chineseName} (${countryName})` : countryName;
                    tooltip
                        .style("opacity", 1)
                        .html(`
                            <strong>${displayName}</strong><br/>
                            ${gdpValue !== null ? `GDP: ${gdpValue.toFixed(2)} ä¸‡äº¿ç¾å…ƒ` : 'GDPæ•°æ®: æš‚æ— '}
                        `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this)
                        .attr("stroke", "#fff")
                        .attr("stroke-width", 0.5);

                    d3.select("#map-tooltip")
                        .style("opacity", 0);
                })
                .transition()
                .duration(500)
                .style("opacity", 1);

            // æ·»åŠ æ ‡é¢˜
            svg.append("text")
                .attr("x", containerWidth / 2)
                .attr("y", 30)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("font-weight", "bold")
                .text(`${selectedYear} å¹´ä¸–ç•Œå„å›½ GDP åˆ†å¸ƒå›¾ (ä¸‡äº¿ç¾å…ƒ)`);

            // æ·»åŠ å›¾ä¾‹
            const legendWidth = 300;
            const legendHeight = 200;
            const legend = d3.select("#map-legend")
                .append("svg")
                .attr("width", legendWidth)
                .attr("height", legendHeight);

            const legendX = 20;
            const legendY = 20;
            const legendItemHeight = 25;

            const legendData = [
                { label: "> 20", color: "#00264d" },
                { label: "10 - 20", color: "#004080" },
                { label: "5 - 10", color: "#0066cc" },
                { label: "2 - 5", color: "#3399cc" },
                { label: "1 - 2", color: "#66b3d9" },
                { label: "0.5 - 1", color: "#b3d9e6" },
                { label: "0.1 - 0.5", color: "#e8f4f8" },
                { label: "< 0.1 / æ— æ•°æ®", color: "#e0e0e0" }
            ];

            legend.selectAll(".legend-item")
                .data(legendData)
                .enter()
                .append("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(${legendX}, ${legendY + i * legendItemHeight})`);

            legend.selectAll(".legend-item")
                .append("rect")
                .attr("width", 20)
                .attr("height", 18)
                .attr("fill", d => d.color)
                .attr("stroke", "#333")
                .attr("stroke-width", 0.5);

            legend.selectAll(".legend-item")
                .append("text")
                .attr("x", 30)
                .attr("y", 14)
                .style("font-size", "12px")
                .text(d => d.label + " ä¸‡äº¿ç¾å…ƒ");

            // æ·»åŠ ç¼©æ”¾åŠŸèƒ½
            const zoom = d3.zoom()
                .scaleExtent([0.5, 8])
                .on("zoom", function(event) {
                    mapGroup.attr("transform", event.transform);
                });

            svg.call(zoom);

            mapZoom = zoom;
        }

        // --- äº‹ä»¶ç›‘å¬å™¨ï¼šä¸–ç•Œåœ°å›¾ ---
        d3.select("#draw-map").on("click", () => {
            if (!worldMapData) {
                loadWorldMap().then(loaded => {
                    if (loaded) drawWorldMap();
                });
            } else {
                drawWorldMap();
            }
        });

        d3.select("#reset-map-zoom").on("click", () => {
            if (mapZoom) {
                d3.select("#world-map-chart svg")
                    .transition()
                    .duration(750)
                    .call(mapZoom.transform, d3.zoomIdentity);
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        loadData();

    </script>

</body>
</html>